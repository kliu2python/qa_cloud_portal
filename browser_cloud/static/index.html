<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Cloud Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card.ready .value {
            color: #10b981;
        }

        .stat-card.busy .value {
            color: #f59e0b;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .session-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .session-card:hover {
            border-color: #667eea;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-id {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #666;
            word-break: break-all;
        }

        .session-info {
            margin-bottom: 10px;
        }

        .session-info strong {
            color: #333;
            display: inline-block;
            width: 100px;
        }

        .session-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            flex: 1;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .nodes-list {
            display: grid;
            gap: 15px;
        }

        .node-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .node-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .node-status.available {
            background: #d1fae5;
            color: #065f46;
        }

        .node-status.busy {
            background: #fed7aa;
            color: #92400e;
        }

        .error-message {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
            color: #991b1b;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .refresh-info {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .queue-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Browser Cloud Dashboard</h1>
            <p>Selenium Grid Management & Monitoring</p>
        </div>

        <div id="error-container"></div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <h3>Active Sessions</h3>
                <div class="value" id="active-sessions">-</div>
            </div>
            <div class="stat-card ready">
                <h3>Available Slots</h3>
                <div class="value" id="available-slots">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Nodes</h3>
                <div class="value" id="total-nodes">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Slots</h3>
                <div class="value" id="total-slots">-</div>
            </div>
        </div>

        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; border: none; padding: 0;">Active Sessions</h2>
                <div class="refresh-info">Auto-refresh: <span id="countdown">5</span>s</div>
            </div>
            <div id="sessions-container">
                <div class="loading">Loading sessions...</div>
            </div>
        </div>

        <div class="section">
            <h2>Grid Nodes</h2>
            <div id="nodes-container">
                <div class="loading">Loading nodes...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1/browser_cloud';
        let countdown = 5;
        let countdownInterval;

        // Fetch and display grid status
        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                clearError();
                updateStats(data.statistics);
                updateSessions(data.sessions);
                updateNodes(data.nodes);

                // Reset countdown
                countdown = 5;
            } catch (error) {
                console.error('Failed to fetch status:', error);
                showError('Failed to connect to the server');
            }
        }

        // Update statistics
        function updateStats(stats) {
            document.getElementById('active-sessions').textContent = stats.active_sessions || 0;
            document.getElementById('available-slots').textContent = stats.available_slots || 0;
            document.getElementById('total-nodes').textContent = stats.total_nodes || 0;
            document.getElementById('total-slots').textContent = stats.total_slots || 0;
        }

        // Update sessions display
        function updateSessions(sessions) {
            const container = document.getElementById('sessions-container');

            if (!sessions || sessions.length === 0) {
                container.innerHTML = '<div class="empty-state">No active sessions</div>';
                return;
            }

            container.innerHTML = '<div class="sessions-grid">' +
                sessions.map(session => {
                    const caps = session.capabilities || {};
                    const browserName = caps.browserName || 'Unknown';
                    const browserVersion = caps.browserVersion || caps.version || 'Unknown';
                    const platform = caps.platformName || caps.platform || 'Unknown';

                    return `
                        <div class="session-card">
                            <div class="session-header">
                                <strong>${browserName} ${browserVersion}</strong>
                            </div>
                            <div class="session-id">${session.id}</div>
                            <div class="session-info">
                                <strong>Platform:</strong> ${platform}
                            </div>
                            <div class="session-info">
                                <strong>Node:</strong> ${session.nodeId ? session.nodeId.substring(0, 20) + '...' : 'N/A'}
                            </div>
                            <div class="session-info">
                                <strong>VNC:</strong> ${session.vncEnabled ? 'Enabled' : 'Disabled'}
                            </div>
                            <div class="session-actions">
                                ${session.vncEnabled ? `
                                    <button class="btn btn-primary" onclick="openVNC('${session.id}')">
                                        Open VNC
                                    </button>
                                ` : ''}
                                <button class="btn btn-danger" onclick="deleteSession('${session.id}')">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') +
                '</div>';
        }

        // Update nodes display
        function updateNodes(nodes) {
            const container = document.getElementById('nodes-container');

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="empty-state">No nodes available</div>';
                return;
            }

            container.innerHTML = '<div class="nodes-list">' +
                nodes.map(node => {
                    const slots = node.slots || [];
                    const availableSlots = slots.filter(s => !s.session).length;
                    const totalSlots = slots.length;
                    const status = availableSlots > 0 ? 'available' : 'busy';

                    return `
                        <div class="node-card">
                            <div class="node-header">
                                <div>
                                    <strong>Node:</strong> ${node.id ? node.id.substring(0, 40) + '...' : 'N/A'}
                                    <div style="margin-top: 5px; color: #666;">
                                        ${node.uri || 'N/A'}
                                    </div>
                                </div>
                                <span class="node-status ${status}">
                                    ${availableSlots}/${totalSlots} Available
                                </span>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="drainNode('${node.id}')">
                                    Drain Node
                                </button>
                                <button class="btn btn-danger" onclick="deleteNode('${node.id}')">
                                    Remove Node
                                </button>
                            </div>
                        </div>
                    `;
                }).join('') +
                '</div>';
        }

        // Delete session
        async function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/session/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Session deleted successfully');
                    fetchStatus();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete session: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to delete session:', error);
                alert('Failed to delete session');
            }
        }

        // Drain node
        async function drainNode(nodeId) {
            if (!confirm('Are you sure you want to drain this node?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/node/${nodeId}/drain`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Node is being drained');
                    fetchStatus();
                } else {
                    const error = await response.json();
                    alert(`Failed to drain node: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to drain node:', error);
                alert('Failed to drain node');
            }
        }

        // Delete node
        async function deleteNode(nodeId) {
            if (!confirm('Are you sure you want to remove this node?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/node/${nodeId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Node removed successfully');
                    fetchStatus();
                } else {
                    const error = await response.json();
                    alert(`Failed to remove node: ${error.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to remove node:', error);
                alert('Failed to remove node');
            }
        }

        // Open VNC (placeholder - would need noVNC integration)
        function openVNC(sessionId) {
            alert(`VNC for session ${sessionId}\n\nTo implement full VNC support, integrate noVNC library and connect to /vnc/${sessionId}`);
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        // Clear error
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }

        // Update countdown
        function updateCountdown() {
            countdown--;
            document.getElementById('countdown').textContent = countdown;

            if (countdown <= 0) {
                fetchStatus();
                countdown = 5;
            }
        }

        // Initialize
        fetchStatus();
        countdownInterval = setInterval(updateCountdown, 1000);
    </script>
</body>
</html>
